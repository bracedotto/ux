!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("blockstack"),require("jsontokens"),require("@blockstack/stacks-transactions"),require("@stacks/connect-ui"),require("@stacks/auth")):"function"==typeof define&&define.amd?define(["exports","blockstack","jsontokens","@blockstack/stacks-transactions","@stacks/connect-ui","@stacks/auth"],n):n((e=e||self)["@stacks/connect"]={},e.blockstack,e.jsontokens,e.stacksTransactions,e.connectUi,e.auth)}(this,(function(e,n,t,r,o,i){"use strict";function s(){return(s=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e}).apply(this,arguments)}function a(e,n){if(null==e)return{};var t,r,o={},i=Object.keys(e);for(r=0;r<i.length;r++)n.indexOf(t=i[r])>=0||(o[t]=e[t]);return o}var c=function(e){var n=e.url,t=e.title,r=void 0===t?"Continue with Secret Key":t,o=e.w,i=void 0===o?442:o,s=e.h,a=void 0===s?532:s,c=e.skipPopupFallback,u=window,p=void 0!==u.safari,l=u.innerWidth,f=u.innerHeight,d=u.outerHeight-u.innerHeight,h=u.outerWidth-u.innerWidth,v=u.screenX-(u.screen.width-u.screen.availWidth),m={scrollbars:"no",width:i,height:a,top:function(e){return e-(u.screen.height-u.screen.availHeight)}(u.screenY)+d+(f-a)/2+(p?48:0),left:v+h+(l-i)/2},g=Object.keys(m).map((function(e){return e+"="+m[e]})),k=window.open(n,r,g.join(","));return k?(k.focus(),k):c?k:window.open(n)},u=function(e){var n=e.popup,t=e.messageParams,r=e.onFinish,o=e.onCancel,i=e.authURL,a=null,c=setInterval((function(){if(n)try{n.postMessage(s({method:"ping"},t),i.origin)}catch(e){console.warn("[Blockstack] Unable to send ping to authentication service"),clearInterval(c)}else console.warn("[Blockstack] Unable to send ping to authentication service - popup closed");a&&(new Date).getTime()-a>2e3&&(o&&o(),clearInterval(c))}),250),u=function(e){!function(e){try{if("pong"===e.data.method)return a=(new Date).getTime(),Promise.resolve();var n=function(){if("blockstack-app"===e.data.source)return Promise.resolve(r(e.data)).then((function(){window.focus(),window.removeEventListener("message",u),clearInterval(c)}))}();Promise.resolve(n&&n.then?n.then((function(){})):void 0)}catch(e){return Promise.reject(e)}}(e)};window.addEventListener("message",u,!1)};"undefined"!=typeof window&&(window.__CONNECT_VERSION__="4.3.15");var p,l,f=function(){var e=navigator.userAgent;return!!(/android/i.test(e)||/iPad|iPhone|iPod/.test(e)||/safari/i.test(e)||/windows phone/i.test(e))},d=function(){return!f()},h=function(e){if(!e){var t=new n.AppConfig(["store_write"],document.location.href);e=new n.UserSession({appConfig:t})}return e},v=function(e){var n=e.redirectTo,t=void 0===n?"/":n,r=e.manifestPath,o=e.finished,i=e.onFinish,s=e.onCancel,a=e.authOrigin,u=e.sendToSignIn,p=void 0!==u&&u,l=e.userSession,f=e.appDetails;try{var v,g=h(l);g.isUserSignedIn()&&g.signUserOut();var k=g.generateAndStoreTransitKey(),y=g.makeAuthRequest(k,""+document.location.origin+t,""+document.location.origin+r,g.appConfig.scopes,void 0,void 0,{sendToSignIn:p,appDetails:f,connectVersion:"4.3.15"}),w=window.location.search.substr(1).split("&").filter((function(e){return e.startsWith("utm")})).map((function(e){return e.split("=")})),P=new URLSearchParams;w.forEach((function(e){return P.set(e[0],e[1])})),P.set("authRequest",y);var C=p?"sign-in":"sign-up";return Promise.resolve(null===(v=window.BlockstackProvider)||void 0===v?void 0:v.getURL()).then((function(e){var n=new URL(e||a||"https://app.blockstack.org"),t=n.origin+"/index.html#/"+C+"?"+P.toString();if(d()){var r=c({url:t,skipPopupFallback:!!window.BlockstackProvider});m({popup:r,authRequest:y,onFinish:i||o,authURL:n,userSession:g,onCancel:s})}else document.location.href=t}))}catch(e){return Promise.reject(e)}},m=function(e){var n=e.authRequest,t=e.onFinish,r=e.userSession;u({popup:e.popup,onCancel:e.onCancel,onFinish:function(e){try{var o=function(){if(e.authRequest===n){var o=function(){if(t){var n=e.authResponse;return Promise.resolve(r.handlePendingSignIn(n)).then((function(){t({authResponse:n,userSession:r})}))}}();if(o&&o.then)return o.then((function(){}))}}();return Promise.resolve(o&&o.then?o.then((function(){})):void 0)}catch(e){return Promise.reject(e)}},messageParams:{authRequest:n},authURL:e.authURL})};(p=e.TransactionTypes||(e.TransactionTypes={})).ContractCall="contract_call",p.ContractDeploy="smart_contract",p.STXTransfer="token_transfer",(l=e.ContractCallArgumentType||(e.ContractCallArgumentType={})).BUFFER="buffer",l.UINT="uint",l.INT="int",l.PRINCIPAL="principal",l.BOOL="bool";var g=function(e,n){try{return Promise.resolve(n(e)).then((function(n){return w({token:n,opts:e})}))}catch(e){return Promise.reject(e)}},k=function(e){var r=e;if(!r){var o=new n.AppConfig(["store_write"],document.location.href);r=new n.UserSession({appConfig:o})}var i=r.loadUserData().appPrivateKey;return{privateKey:i,publicKey:t.SECP256K1Client.derivePublicKey(i)}},y=function(e,n){try{var r=new t.TokenSigner("ES256k",n);return Promise.resolve(r.signAsync(e))}catch(e){return Promise.reject(e)}},w=function(e){var n=e.token,t=e.opts;try{var r;return Promise.resolve(null===(r=window.BlockstackProvider)||void 0===r?void 0:r.getURL()).then((function(e){var r=new URL(e||t.authOrigin||"https://app.blockstack.org"),o=new URLSearchParams;o.set("request",n);var i=c({url:r.origin+"/index.html#/transaction?"+o.toString(),h:700});return u({popup:i,authURL:r,onFinish:function(e){t.finished&&t.finished(e)},messageParams:{}}),i}))}catch(e){return Promise.reject(e)}},P=function(n){try{var t=n.functionArgs,o=n.appDetails,i=n.userSession,c=a(n,["functionArgs","appDetails","userSession"]),u=k(i),p=u.privateKey,l=u.publicKey,f=s({},c,{functionArgs:t.map((function(e){return"string"==typeof e?e:r.serializeCV(e).toString("hex")})),txType:e.TransactionTypes.ContractCall,publicKey:l});return o&&(f.appDetails=o),y(f,p)}catch(e){return Promise.reject(e)}},C=function(n){try{var t=n.appDetails,r=n.userSession,o=a(n,["appDetails","userSession"]),i=k(r),c=i.privateKey,u=s({},o,{publicKey:i.publicKey,txType:e.TransactionTypes.ContractDeploy});return t&&(u.appDetails=t),y(u,c)}catch(e){return Promise.reject(e)}},S=function(n){try{var t=n.amount,r=n.appDetails,o=n.userSession,i=a(n,["amount","appDetails","userSession"]),c=k(o),u=c.privateKey,p=c.publicKey,l=s({},i,{amount:t.toString(10),publicKey:p,txType:e.TransactionTypes.STXTransfer});return r&&(l.appDetails=r),y(l,u)}catch(e){return Promise.reject(e)}},T=function(e){o.defineCustomElements();var n=document.createElement("connect-modal");n.authOptions=e,document.body.appendChild(n);var t=function(t){n.remove();var r=e.onFinish||e.finished;r&&r(t)};n.addEventListener("onSignUp",(function(){v(s({},e,{sendToSignIn:!1,onFinish:t}))})),n.addEventListener("onSignIn",(function(){v(s({},e,{sendToSignIn:!0,onFinish:t}))}));var r=function e(t){"Escape"===t.key&&(document.removeEventListener("keydown",e),n.remove())};n.addEventListener("onCloseModal",(function(){document.removeEventListener("keydown",r),n.remove()})),document.addEventListener("keydown",r)};Object.keys(i).forEach((function(n){"default"!==n&&Object.defineProperty(e,n,{enumerable:!0,get:function(){return i[n]}})})),e.authenticate=v,e.defaultAuthURL="https://app.blockstack.org",e.getOrCreateUserSession=h,e.getUserData=function(e){try{return(e=h(e)).isUserSignedIn()?Promise.resolve(e.loadUserData()):e.isSignInPending()?Promise.resolve(e.handlePendingSignIn()):Promise.resolve(null)}catch(e){return Promise.reject(e)}},e.isMobile=f,e.makeContractCallToken=P,e.makeContractDeployToken=C,e.makeSTXTransferToken=S,e.openContractCall=function(e){return g(e,P)},e.openContractDeploy=function(e){return g(e,C)},e.openSTXTransfer=function(e){return g(e,S)},e.popupCenter=c,e.setupListener=u,e.shouldUsePopup=d,e.showBlockstackConnect=function(e){return T(e)},e.showConnect=T}));
//# sourceMappingURL=connect.umd.production.min.js.map
