{"version":3,"file":"connect.umd.development.js","sources":["../src/popup.ts","../src/auth.ts","../src/transactions/types.ts","../src/transactions/index.ts","../src/ui.ts"],"sourcesContent":["interface PopupOptions {\n  url?: string;\n  title?: string;\n  w?: number;\n  h?: number;\n  skipPopupFallback?: boolean;\n}\n\n// Width 2px wider than in-page dialog.\n// Ensures retina subpixel rounding\n// does not leave slightly blurry underlap\nconst defaultWidth = 442;\nconst defaultHeight = 532;\nconst defaultTitle = 'Continue with Secret Key';\n\n// https://developer.mozilla.org/en-US/docs/Web/API/Window/open\nexport const popupCenter = ({\n  url,\n  title = defaultTitle,\n  w = defaultWidth,\n  h = defaultHeight,\n  skipPopupFallback,\n}: PopupOptions) => {\n  const win = window;\n  // Safari reports an incorrect browser height\n  const isSafari = (win as any).safari !== undefined;\n\n  const browserViewport = {\n    width: win.innerWidth,\n    height: win.innerHeight,\n  };\n  const browserToolbarHeight = win.outerHeight - win.innerHeight;\n  const browserSidepanelWidth = win.outerWidth - win.innerWidth;\n\n  // Such as fixed operating system UI\n  const removeUnusableSpaceX = (coord: number) =>\n    coord - (win.screen.width - win.screen.availWidth);\n  const removeUnusableSpaceY = (coord: number) =>\n    coord - (win.screen.height - win.screen.availHeight);\n\n  const browserPosition = {\n    x: removeUnusableSpaceX(win.screenX),\n    y: removeUnusableSpaceY(win.screenY),\n  };\n\n  const left = browserPosition.x + browserSidepanelWidth + (browserViewport.width - w) / 2;\n  const top =\n    browserPosition.y +\n    browserToolbarHeight +\n    (browserViewport.height - h) / 2 +\n    (isSafari ? 48 : 0);\n\n  const options = {\n    scrollbars: 'no',\n    width: w,\n    height: h,\n    top,\n    left,\n  };\n  const optionsString = Object.keys(options).map(key => {\n    return `${key}=${options[key as keyof typeof options]}`;\n  });\n  const newWindow = window.open(url, title, optionsString.join(','));\n\n  if (newWindow) {\n    newWindow.focus();\n    return newWindow;\n  }\n\n  // no popup options, just open the auth page\n  if (skipPopupFallback) {\n    return newWindow;\n  }\n  return window.open(url);\n};\n\ninterface ListenerParams<FinishedType> {\n  popup: Window | null;\n  messageParams: {\n    [key: string]: any;\n  };\n  onFinish: (payload: FinishedType) => void | Promise<void>;\n  onCancel?: () => void;\n  authURL: URL;\n}\n\nexport const setupListener = <T>({\n  popup,\n  messageParams,\n  onFinish,\n  onCancel,\n  authURL,\n}: ListenerParams<T>) => {\n  let lastPong: number | null = null;\n\n  // Send a message to the authenticator popup at a consistent interval. This allows\n  // the authenticator to 'respond'.\n  const pingInterval = 250;\n  const interval = setInterval(() => {\n    if (popup) {\n      try {\n        popup.postMessage(\n          {\n            method: 'ping',\n            ...messageParams,\n          },\n          authURL.origin\n        );\n      } catch (error) {\n        console.warn('[Blockstack] Unable to send ping to authentication service');\n        clearInterval(interval);\n      }\n    } else {\n      console.warn('[Blockstack] Unable to send ping to authentication service - popup closed');\n    }\n    // If we haven't received a \"pong\" recently, then the popup was probably closed\n    // by the user. 750ms has been tested by most browsers. Most respond in less than\n    // 500ms, although Safari can often take around 600-650ms.\n    if (lastPong && new Date().getTime() - lastPong > pingInterval * 8) {\n      onCancel && onCancel();\n      clearInterval(interval);\n    }\n  }, pingInterval);\n\n  const receiveMessage = async (event: MessageEvent) => {\n    if (event.data.method === 'pong') {\n      lastPong = new Date().getTime();\n      return;\n    }\n    if (event.data.source === 'blockstack-app') {\n      const data = event.data as T;\n      await onFinish(data);\n      window.focus();\n      window.removeEventListener('message', receiveMessageCallback);\n      clearInterval(interval);\n    }\n  };\n\n  const receiveMessageCallback = (event: MessageEvent) => {\n    void receiveMessage(event);\n  };\n\n  window.addEventListener('message', receiveMessageCallback, false);\n};\n","import { AppConfig, UserSession } from 'blockstack';\nimport './types';\nimport { popupCenter, setupListener } from './popup';\nimport { version } from '../package.json';\n\nexport const defaultAuthURL = 'https://app.blockstack.org';\n\nif (typeof window !== 'undefined') {\n  (window as any).__CONNECT_VERSION__ = version;\n}\n\nexport interface FinishedData {\n  authResponse: string;\n  userSession: UserSession;\n}\n\nexport interface AuthOptions {\n  /** The URL you want the user to be redirected to after authentication. */\n  redirectTo?: string;\n  manifestPath?: string;\n  /** DEPRECATED: use `onFinish` */\n  finished?: (payload: FinishedData) => void;\n  /**\n   * This callback is fired after authentication is finished.\n   * The callback is called with a single object argument, with two keys:\n   * `userSession`: a UserSession object with `userData` included\n   * `authResponse`: the raw `authResponse` string that is returned from authentication\n   * */\n  onFinish?: (payload: FinishedData) => void;\n  /** This callback is fired if the user exits before finishing */\n  onCancel?: () => void;\n  authOrigin?: string;\n  sendToSignIn?: boolean;\n  userSession?: UserSession;\n  appDetails: {\n    name: string;\n    icon: string;\n  };\n}\n\nexport const isMobile = () => {\n  const ua = navigator.userAgent;\n  if (/android/i.test(ua)) {\n    return true;\n  }\n  if (/iPad|iPhone|iPod/.test(ua)) {\n    return true;\n  }\n  if (/safari/i.test(ua)) {\n    return true;\n  }\n  if (/windows phone/i.test(ua)) {\n    return true;\n  }\n  return false;\n};\n\n/**\n * mobile should not use a 'popup' type of window.\n */\nexport const shouldUsePopup = () => {\n  return !isMobile();\n};\n\nexport const getOrCreateUserSession = (userSession?: UserSession): UserSession => {\n  if (!userSession) {\n    const appConfig = new AppConfig(['store_write'], document.location.href);\n    userSession = new UserSession({ appConfig });\n  }\n  return userSession;\n};\n\nexport const authenticate = async ({\n  redirectTo = '/',\n  manifestPath,\n  finished,\n  onFinish,\n  onCancel,\n  authOrigin,\n  sendToSignIn = false,\n  userSession: _userSession,\n  appDetails,\n}: AuthOptions) => {\n  const userSession = getOrCreateUserSession(_userSession);\n  if (userSession.isUserSignedIn()) {\n    userSession.signUserOut();\n  }\n  const transitKey = userSession.generateAndStoreTransitKey();\n  const authRequest = userSession.makeAuthRequest(\n    transitKey,\n    `${document.location.origin}${redirectTo}`,\n    `${document.location.origin}${manifestPath}`,\n    userSession.appConfig.scopes,\n    undefined,\n    undefined,\n    {\n      sendToSignIn,\n      appDetails,\n      connectVersion: version,\n    }\n  );\n\n  const params = window.location.search\n    .substr(1)\n    .split('&')\n    .filter(param => param.startsWith('utm'))\n    .map(param => param.split('='));\n  const urlParams = new URLSearchParams();\n  params.forEach(([key, value]) => urlParams.set(key, value));\n  urlParams.set('authRequest', authRequest);\n\n  const path = sendToSignIn ? 'sign-in' : 'sign-up';\n\n  const extensionURL = await window.BlockstackProvider?.getURL();\n  const authURL = new URL(extensionURL || authOrigin || defaultAuthURL);\n\n  const url = `${authURL.origin}/index.html#/${path}?${urlParams.toString()}`;\n  if (shouldUsePopup()) {\n    const popup = popupCenter({\n      url,\n      // If the extension is installed, dont worry about popup blocking\n      // Otherwise, firefox will open the popup and a new tab.\n      skipPopupFallback: !!window.BlockstackProvider,\n    });\n\n    setupAuthListener({\n      popup,\n      authRequest,\n      onFinish: onFinish || finished,\n      authURL,\n      userSession,\n      onCancel,\n    });\n    return;\n  }\n\n  document.location.href = url;\n};\n\ninterface FinishedEventData {\n  authResponse: string;\n  authRequest: string;\n  source: string;\n}\n\ninterface ListenerParams {\n  popup: Window | null;\n  authRequest: string;\n  onFinish?: (payload: FinishedData) => void;\n  onCancel?: () => void;\n  authURL: URL;\n  userSession: UserSession;\n}\n\nconst setupAuthListener = ({\n  popup,\n  authRequest,\n  onFinish,\n  onCancel,\n  authURL,\n  userSession,\n}: ListenerParams) => {\n  setupListener<FinishedEventData>({\n    popup,\n    onCancel,\n    onFinish: async (data: FinishedEventData) => {\n      if (data.authRequest === authRequest) {\n        if (onFinish) {\n          const { authResponse } = data;\n          await userSession.handlePendingSignIn(authResponse);\n          onFinish({\n            authResponse,\n            userSession,\n          });\n        }\n      }\n    },\n    messageParams: {\n      authRequest,\n    },\n    authURL,\n  });\n};\n\nexport const getUserData = async (userSession?: UserSession) => {\n  userSession = getOrCreateUserSession(userSession);\n  if (userSession.isUserSignedIn()) {\n    return userSession.loadUserData();\n  }\n  if (userSession.isSignInPending()) {\n    return userSession.handlePendingSignIn();\n  }\n  return null;\n};\n","import { UserSession } from 'blockstack';\nimport { AuthOptions } from '../auth';\nimport {\n  PostConditionMode,\n  PostCondition,\n  StacksNetwork,\n  AnchorMode,\n  ClarityValue,\n} from '@blockstack/stacks-transactions';\nimport BN from 'bn.js';\n\nexport interface TxBase {\n  appDetails?: AuthOptions['appDetails'];\n  postConditionMode?: PostConditionMode;\n  postConditions?: PostCondition[];\n  network?: StacksNetwork;\n  anchorMode?: AnchorMode;\n  senderKey?: string;\n  nonce?: number;\n}\n\nexport interface FinishedTxData {\n  txId: string;\n  txRaw: string;\n}\n\nexport enum TransactionTypes {\n  ContractCall = 'contract_call',\n  ContractDeploy = 'smart_contract',\n  STXTransfer = 'token_transfer',\n}\n\n/**\n * Contract Call\n */\n\nexport enum ContractCallArgumentType {\n  BUFFER = 'buffer',\n  UINT = 'uint',\n  INT = 'int',\n  PRINCIPAL = 'principal',\n  BOOL = 'bool',\n}\n\nexport interface ContractCallBase extends TxBase {\n  contractAddress: string;\n  contractName: string;\n  functionName: string;\n  functionArgs: (string | ClarityValue)[];\n}\n\nexport interface ContractCallOptions extends ContractCallBase {\n  authOrigin?: string;\n  userSession?: UserSession;\n  finished?: (data: FinishedTxData) => void;\n}\n\nexport interface ContractCallArgument {\n  type: ContractCallArgumentType;\n  value: string;\n}\n\nexport interface ContractCallPayload extends ContractCallBase {\n  txType: TransactionTypes.ContractCall;\n  publicKey: string;\n  functionArgs: string[];\n}\n\n/**\n * Contract Deploy\n */\nexport interface ContractDeployBase extends TxBase {\n  contractName: string;\n  codeBody: string;\n}\n\nexport interface ContractDeployOptions extends ContractDeployBase {\n  authOrigin?: string;\n  userSession?: UserSession;\n  finished?: (data: FinishedTxData) => void;\n}\n\nexport interface ContractDeployPayload extends ContractDeployOptions {\n  publicKey: string;\n  txType: TransactionTypes.ContractDeploy;\n}\n\n/**\n * STX Transfer\n */\n\nexport interface STXTransferBase extends TxBase {\n  recipient: string;\n  amount: BN | string;\n  memo?: string;\n}\n\nexport interface STXTransferOptions extends STXTransferBase {\n  authOrigin?: string;\n  userSession?: UserSession;\n  finished?: (data: FinishedTxData) => void;\n}\n\nexport interface STXTransferPayload extends STXTransferOptions {\n  publicKey: string;\n  txType: TransactionTypes.STXTransfer;\n  amount: string;\n}\n\n/**\n * Transaction Popup\n */\n\nexport type TransactionOptions = ContractCallOptions | ContractDeployOptions | STXTransferOptions;\nexport type TransactionPayload = ContractCallPayload | ContractDeployPayload | STXTransferPayload;\n\nexport interface TransactionPopup {\n  token: string;\n  opts: TransactionOptions;\n}\n","import { UserSession, AppConfig } from 'blockstack';\nimport { SECP256K1Client, TokenSigner } from 'jsontokens';\nimport { defaultAuthURL } from '../auth';\nimport { popupCenter, setupListener } from '../popup';\nimport {\n  ContractCallOptions,\n  ContractCallPayload,\n  ContractDeployOptions,\n  ContractDeployPayload,\n  FinishedTxData,\n  TransactionPopup,\n  TransactionOptions,\n  STXTransferOptions,\n  STXTransferPayload,\n  TransactionPayload,\n  TransactionTypes,\n} from './types';\nimport { serializeCV } from '@blockstack/stacks-transactions';\n\nexport * from './types';\n\nconst getKeys = (_userSession?: UserSession) => {\n  let userSession = _userSession;\n\n  if (!userSession) {\n    const appConfig = new AppConfig(['store_write'], document.location.href);\n    userSession = new UserSession({ appConfig });\n  }\n\n  const privateKey = userSession.loadUserData().appPrivateKey;\n  const publicKey = SECP256K1Client.derivePublicKey(privateKey);\n\n  return { privateKey, publicKey };\n};\n\nconst signPayload = async (payload: TransactionPayload, privateKey: string) => {\n  const tokenSigner = new TokenSigner('ES256k', privateKey);\n  return tokenSigner.signAsync(payload as any);\n};\n\nconst openTransactionPopup = async ({ token, opts }: TransactionPopup) => {\n  const extensionURL = await window.BlockstackProvider?.getURL();\n  const authURL = new URL(extensionURL || opts.authOrigin || defaultAuthURL);\n  const urlParams = new URLSearchParams();\n  urlParams.set('request', token);\n\n  const popup = popupCenter({\n    url: `${authURL.origin}/index.html#/transaction?${urlParams.toString()}`,\n    h: 700,\n  });\n\n  setupListener<FinishedTxData>({\n    popup,\n    authURL,\n    onFinish: data => {\n      if (opts.finished) {\n        opts.finished(data);\n      }\n    },\n    messageParams: {},\n  });\n  return popup;\n};\n\nexport const makeContractCallToken = async (opts: ContractCallOptions) => {\n  const { functionArgs, appDetails, userSession, ...options } = opts;\n  const { privateKey, publicKey } = getKeys(userSession);\n\n  const args: string[] = functionArgs.map(arg => {\n    if (typeof arg === 'string') {\n      return arg;\n    }\n    return serializeCV(arg).toString('hex');\n  });\n\n  const payload: ContractCallPayload = {\n    ...options,\n    functionArgs: args,\n    txType: TransactionTypes.ContractCall,\n    publicKey,\n  };\n\n  if (appDetails) {\n    payload.appDetails = appDetails;\n  }\n\n  return signPayload(payload, privateKey);\n};\n\nexport const makeContractDeployToken = async (opts: ContractDeployOptions) => {\n  const { appDetails, userSession, ...options } = opts;\n  const { privateKey, publicKey } = getKeys(userSession);\n\n  const payload: ContractDeployPayload = {\n    ...options,\n    publicKey,\n    txType: TransactionTypes.ContractDeploy,\n  };\n\n  if (appDetails) {\n    payload.appDetails = appDetails;\n  }\n\n  return signPayload(payload, privateKey);\n};\n\nexport const makeSTXTransferToken = async (opts: STXTransferOptions) => {\n  const { amount, appDetails, userSession, ...options } = opts;\n  const { privateKey, publicKey } = getKeys(userSession);\n\n  const payload: STXTransferPayload = {\n    ...options,\n    amount: amount.toString(10),\n    publicKey,\n    txType: TransactionTypes.STXTransfer,\n  };\n\n  if (appDetails) {\n    payload.appDetails = appDetails;\n  }\n\n  return signPayload(payload, privateKey);\n};\n\nasync function generateTokenAndOpenPopup<T extends TransactionOptions>(\n  opts: T,\n  makeTokenFn: (opts: T) => Promise<string>\n) {\n  const token = await makeTokenFn(opts);\n  return openTransactionPopup({ token, opts });\n}\n\nexport const openContractCall = async (opts: ContractCallOptions) =>\n  generateTokenAndOpenPopup(opts, makeContractCallToken);\n\nexport const openContractDeploy = async (opts: ContractDeployOptions) =>\n  generateTokenAndOpenPopup(opts, makeContractDeployToken);\n\nexport const openSTXTransfer = async (opts: STXTransferOptions) =>\n  generateTokenAndOpenPopup(opts, makeSTXTransferToken);\n","import { authenticate, AuthOptions, FinishedData } from './auth';\nimport { defineCustomElements } from '@stacks/connect-ui';\n\nexport const showConnect = (authOptions: AuthOptions) => {\n  defineCustomElements();\n  const element = document.createElement('connect-modal');\n  element.authOptions = authOptions;\n  document.body.appendChild(element);\n  const finishedWrapper = (finishedData: FinishedData) => {\n    element.remove();\n    const callback = authOptions.onFinish || authOptions.finished;\n    if (callback) {\n      callback(finishedData);\n    }\n  };\n  element.addEventListener('onSignUp', () => {\n    authenticate({\n      ...authOptions,\n      sendToSignIn: false,\n      onFinish: finishedWrapper,\n    });\n  });\n  element.addEventListener('onSignIn', () => {\n    authenticate({\n      ...authOptions,\n      sendToSignIn: true,\n      onFinish: finishedWrapper,\n    });\n  });\n  const handleEsc = (ev: KeyboardEvent) => {\n    if (ev.key === 'Escape') {\n      document.removeEventListener('keydown', handleEsc);\n      element.remove();\n    }\n  };\n  element.addEventListener('onCloseModal', () => {\n    document.removeEventListener('keydown', handleEsc);\n    element.remove();\n  });\n  document.addEventListener('keydown', handleEsc);\n};\n\n/**\n * @deprecated Use the renamed `showConnect` method\n */\nexport const showBlockstackConnect = (authOptions: AuthOptions) => showConnect(authOptions);\n"],"names":["defaultWidth","defaultHeight","defaultTitle","popupCenter","url","title","w","h","skipPopupFallback","win","window","isSafari","safari","undefined","browserViewport","width","innerWidth","height","innerHeight","browserToolbarHeight","outerHeight","browserSidepanelWidth","outerWidth","removeUnusableSpaceX","coord","screen","availWidth","removeUnusableSpaceY","availHeight","browserPosition","x","screenX","y","screenY","left","top","options","scrollbars","optionsString","Object","keys","map","key","newWindow","open","join","focus","setupListener","popup","messageParams","onFinish","onCancel","authURL","lastPong","pingInterval","interval","setInterval","postMessage","method","origin","error","console","warn","clearInterval","Date","getTime","receiveMessage","event","data","source","removeEventListener","receiveMessageCallback","addEventListener","defaultAuthURL","__CONNECT_VERSION__","version","isMobile","ua","navigator","userAgent","test","shouldUsePopup","getOrCreateUserSession","userSession","appConfig","AppConfig","document","location","href","UserSession","authenticate","redirectTo","manifestPath","finished","authOrigin","sendToSignIn","_userSession","appDetails","isUserSignedIn","signUserOut","transitKey","generateAndStoreTransitKey","authRequest","makeAuthRequest","scopes","connectVersion","params","search","substr","split","filter","param","startsWith","urlParams","URLSearchParams","forEach","value","set","path","BlockstackProvider","getURL","extensionURL","URL","toString","setupAuthListener","authResponse","handlePendingSignIn","getUserData","loadUserData","isSignInPending","TransactionTypes","ContractCallArgumentType","generateTokenAndOpenPopup","opts","makeTokenFn","token","openTransactionPopup","getKeys","privateKey","appPrivateKey","publicKey","SECP256K1Client","derivePublicKey","signPayload","payload","tokenSigner","TokenSigner","signAsync","makeContractCallToken","functionArgs","args","arg","serializeCV","txType","ContractCall","makeContractDeployToken","ContractDeploy","makeSTXTransferToken","amount","STXTransfer","openContractCall","openContractDeploy","openSTXTransfer","showConnect","authOptions","defineCustomElements","element","createElement","body","appendChild","finishedWrapper","finishedData","remove","callback","handleEsc","ev","showBlockstackConnect"],"mappings":"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"}