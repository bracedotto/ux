"use strict";var e=require("blockstack"),n=require("jsontokens"),t=require("@blockstack/stacks-transactions"),r=require("@stacks/connect-ui"),o=require("@stacks/auth");function i(){return(i=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e}).apply(this,arguments)}function s(e,n){if(null==e)return{};var t,r,o={},i=Object.keys(e);for(r=0;r<i.length;r++)n.indexOf(t=i[r])>=0||(o[t]=e[t]);return o}var a=function(e){var n=e.url,t=e.title,r=void 0===t?"Continue with Secret Key":t,o=e.w,i=void 0===o?442:o,s=e.h,a=void 0===s?532:s,c=e.skipPopupFallback,u=window,p=void 0!==u.safari,l=u.innerWidth,d=u.innerHeight,f=u.outerHeight-u.innerHeight,h=u.outerWidth-u.innerWidth,v=u.screenX-(u.screen.width-u.screen.availWidth),m={scrollbars:"no",width:i,height:a,top:function(e){return e-(u.screen.height-u.screen.availHeight)}(u.screenY)+f+(d-a)/2+(p?48:0),left:v+h+(l-i)/2},g=Object.keys(m).map((function(e){return e+"="+m[e]})),y=window.open(n,r,g.join(","));return y?(y.focus(),y):c?y:window.open(n)},c=function(e){var n=e.popup,t=e.messageParams,r=e.onFinish,o=e.onCancel,s=e.authURL,a=null,c=setInterval((function(){if(n)try{n.postMessage(i({method:"ping"},t),s.origin)}catch(e){console.warn("[Blockstack] Unable to send ping to authentication service"),clearInterval(c)}else console.warn("[Blockstack] Unable to send ping to authentication service - popup closed");a&&(new Date).getTime()-a>2e3&&(o&&o(),clearInterval(c))}),250),u=function(e){!function(e){try{if("pong"===e.data.method)return a=(new Date).getTime(),Promise.resolve();var n=function(){if("blockstack-app"===e.data.source)return Promise.resolve(r(e.data)).then((function(){window.focus(),window.removeEventListener("message",u),clearInterval(c)}))}();Promise.resolve(n&&n.then?n.then((function(){})):void 0)}catch(e){return Promise.reject(e)}}(e)};window.addEventListener("message",u,!1)};"undefined"!=typeof window&&(window.__CONNECT_VERSION__="4.3.15");var u,p,l=function(){var e=navigator.userAgent;return!(!/android/i.test(e)&&!/iPad|iPhone|iPod/.test(e)&&(!/Mac OS X/.test(e)||!/Safari/.test(e)||/Chrome/.test(e)||/Firefox/.test(e))&&!/windows phone/i.test(e))},d=function(){return!l()},f=function(n){if(!n){var t=new e.AppConfig(["store_write"],document.location.href);n=new e.UserSession({appConfig:t})}return n},h=function(e){var n=e.redirectTo,t=void 0===n?"/":n,r=e.manifestPath,o=e.finished,i=e.onFinish,s=e.onCancel,c=e.authOrigin,u=e.sendToSignIn,p=void 0!==u&&u,l=e.userSession,h=e.appDetails;try{var m,g=f(l);g.isUserSignedIn()&&g.signUserOut();var y=g.generateAndStoreTransitKey(),k=g.makeAuthRequest(y,""+document.location.origin+t,""+document.location.origin+r,g.appConfig.scopes,void 0,void 0,{sendToSignIn:p,appDetails:h,connectVersion:"4.3.15"}),w=window.location.search.substr(1).split("&").filter((function(e){return e.startsWith("utm")})).map((function(e){return e.split("=")})),P=new URLSearchParams;w.forEach((function(e){return P.set(e[0],e[1])})),P.set("authRequest",k);var S=p?"sign-in":"sign-up";return Promise.resolve(null===(m=window.BlockstackProvider)||void 0===m?void 0:m.getURL()).then((function(e){var n=new URL(e||c||"https://app.blockstack.org"),t=n.origin+"/index.html#/"+S+"?"+P.toString();if(d()){var r=a({url:t,skipPopupFallback:!!window.BlockstackProvider});v({popup:r,authRequest:k,onFinish:i||o,authURL:n,userSession:g,onCancel:s})}else document.location.href=t}))}catch(e){return Promise.reject(e)}},v=function(e){var n=e.authRequest,t=e.onFinish,r=e.userSession;c({popup:e.popup,onCancel:e.onCancel,onFinish:function(e){try{var o=function(){if(e.authRequest===n){var o=function(){if(t){var n=e.authResponse;return Promise.resolve(r.handlePendingSignIn(n)).then((function(){t({authResponse:n,userSession:r})}))}}();if(o&&o.then)return o.then((function(){}))}}();return Promise.resolve(o&&o.then?o.then((function(){})):void 0)}catch(e){return Promise.reject(e)}},messageParams:{authRequest:n},authURL:e.authURL})};(u=exports.TransactionTypes||(exports.TransactionTypes={})).ContractCall="contract_call",u.ContractDeploy="smart_contract",u.STXTransfer="token_transfer",(p=exports.ContractCallArgumentType||(exports.ContractCallArgumentType={})).BUFFER="buffer",p.UINT="uint",p.INT="int",p.PRINCIPAL="principal",p.BOOL="bool";var m=function(e,n){try{return Promise.resolve(n(e)).then((function(n){return k({token:n,opts:e})}))}catch(e){return Promise.reject(e)}},g=function(t){var r=t;if(!r){var o=new e.AppConfig(["store_write"],document.location.href);r=new e.UserSession({appConfig:o})}var i=r.loadUserData().appPrivateKey;return{privateKey:i,publicKey:n.SECP256K1Client.derivePublicKey(i)}},y=function(e,t){try{var r=new n.TokenSigner("ES256k",t);return Promise.resolve(r.signAsync(e))}catch(e){return Promise.reject(e)}},k=function(e){var n=e.token,t=e.opts;try{var r;return Promise.resolve(null===(r=window.BlockstackProvider)||void 0===r?void 0:r.getURL()).then((function(e){var r=new URL(e||t.authOrigin||"https://app.blockstack.org"),o=new URLSearchParams;o.set("request",n);var i=a({url:r.origin+"/index.html#/transaction?"+o.toString(),h:700});return c({popup:i,authURL:r,onFinish:function(e){t.finished&&t.finished(e)},messageParams:{}}),i}))}catch(e){return Promise.reject(e)}},w=function(e){try{var n=e.functionArgs,r=e.appDetails,o=e.userSession,a=s(e,["functionArgs","appDetails","userSession"]),c=g(o),u=c.privateKey,p=c.publicKey,l=i({},a,{functionArgs:n.map((function(e){return"string"==typeof e?e:t.serializeCV(e).toString("hex")})),txType:exports.TransactionTypes.ContractCall,publicKey:p});return r&&(l.appDetails=r),y(l,u)}catch(e){return Promise.reject(e)}},P=function(e){try{var n=e.appDetails,t=e.userSession,r=s(e,["appDetails","userSession"]),o=g(t),a=o.privateKey,c=i({},r,{publicKey:o.publicKey,txType:exports.TransactionTypes.ContractDeploy});return n&&(c.appDetails=n),y(c,a)}catch(e){return Promise.reject(e)}},S=function(e){try{var n=e.amount,t=e.appDetails,r=e.userSession,o=s(e,["amount","appDetails","userSession"]),a=g(r),c=a.privateKey,u=a.publicKey,p=i({},o,{amount:n.toString(10),publicKey:u,txType:exports.TransactionTypes.STXTransfer});return t&&(p.appDetails=t),y(p,c)}catch(e){return Promise.reject(e)}},C=function(e){r.defineCustomElements();var n=document.createElement("connect-modal");n.authOptions=e,document.body.appendChild(n);var t=function(t){n.remove();var r=e.onFinish||e.finished;r&&r(t)};n.addEventListener("onSignUp",(function(){h(i({},e,{sendToSignIn:!1,onFinish:t}))})),n.addEventListener("onSignIn",(function(){h(i({},e,{sendToSignIn:!0,onFinish:t}))}));var o=function e(t){"Escape"===t.key&&(document.removeEventListener("keydown",e),n.remove())};n.addEventListener("onCloseModal",(function(){document.removeEventListener("keydown",o),n.remove()})),document.addEventListener("keydown",o)};Object.keys(o).forEach((function(e){"default"!==e&&Object.defineProperty(exports,e,{enumerable:!0,get:function(){return o[e]}})})),exports.authenticate=h,exports.defaultAuthURL="https://app.blockstack.org",exports.getOrCreateUserSession=f,exports.getUserData=function(e){try{return(e=f(e)).isUserSignedIn()?Promise.resolve(e.loadUserData()):e.isSignInPending()?Promise.resolve(e.handlePendingSignIn()):Promise.resolve(null)}catch(e){return Promise.reject(e)}},exports.isMobile=l,exports.makeContractCallToken=w,exports.makeContractDeployToken=P,exports.makeSTXTransferToken=S,exports.openContractCall=function(e){return m(e,w)},exports.openContractDeploy=function(e){return m(e,P)},exports.openSTXTransfer=function(e){return m(e,S)},exports.popupCenter=a,exports.setupListener=c,exports.shouldUsePopup=d,exports.showBlockstackConnect=function(e){return C(e)},exports.showConnect=C;
//# sourceMappingURL=connect.cjs.production.min.js.map
