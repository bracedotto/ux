{"version":3,"file":"connect.cjs.development.js","sources":["../src/popup.ts","../src/auth.ts","../src/transactions/types.ts","../src/transactions/index.ts","../src/ui.ts"],"sourcesContent":["interface PopupOptions {\n  url?: string;\n  title?: string;\n  w?: number;\n  h?: number;\n  skipPopupFallback?: boolean;\n}\n\n// Width 2px wider than in-page dialog.\n// Ensures retina subpixel rounding\n// does not leave slightly blurry underlap\nconst defaultWidth = 442;\nconst defaultHeight = 532;\nconst defaultTitle = 'Continue with Secret Key';\n\n// https://developer.mozilla.org/en-US/docs/Web/API/Window/open\nexport const popupCenter = ({\n  url,\n  title = defaultTitle,\n  w = defaultWidth,\n  h = defaultHeight,\n  skipPopupFallback,\n}: PopupOptions) => {\n  const win = window;\n  // Safari reports an incorrect browser height\n  const isSafari = (win as any).safari !== undefined;\n\n  const browserViewport = {\n    width: win.innerWidth,\n    height: win.innerHeight,\n  };\n  const browserToolbarHeight = win.outerHeight - win.innerHeight;\n  const browserSidepanelWidth = win.outerWidth - win.innerWidth;\n\n  // Such as fixed operating system UI\n  const removeUnusableSpaceX = (coord: number) =>\n    coord - (win.screen.width - win.screen.availWidth);\n  const removeUnusableSpaceY = (coord: number) =>\n    coord - (win.screen.height - win.screen.availHeight);\n\n  const browserPosition = {\n    x: removeUnusableSpaceX(win.screenX),\n    y: removeUnusableSpaceY(win.screenY),\n  };\n\n  const left = browserPosition.x + browserSidepanelWidth + (browserViewport.width - w) / 2;\n  const top =\n    browserPosition.y +\n    browserToolbarHeight +\n    (browserViewport.height - h) / 2 +\n    (isSafari ? 48 : 0);\n\n  const options = {\n    scrollbars: 'no',\n    width: w,\n    height: h,\n    top,\n    left,\n  };\n  const optionsString = Object.keys(options).map(key => {\n    return `${key}=${options[key as keyof typeof options]}`;\n  });\n  const newWindow = window.open(url, title, optionsString.join(','));\n\n  if (newWindow) {\n    newWindow.focus();\n    return newWindow;\n  }\n\n  // no popup options, just open the auth page\n  if (skipPopupFallback) {\n    return newWindow;\n  }\n  return window.open(url);\n};\n\ninterface ListenerParams<FinishedType> {\n  popup: Window | null;\n  messageParams: {\n    [key: string]: any;\n  };\n  onFinish: (payload: FinishedType) => void | Promise<void>;\n  onCancel?: () => void;\n  authURL: URL;\n}\n\nexport const setupListener = <T>({\n  popup,\n  messageParams,\n  onFinish,\n  onCancel,\n  authURL,\n}: ListenerParams<T>) => {\n  let lastPong: number | null = null;\n\n  // Send a message to the authenticator popup at a consistent interval. This allows\n  // the authenticator to 'respond'.\n  const pingInterval = 250;\n  const interval = setInterval(() => {\n    if (popup) {\n      try {\n        popup.postMessage(\n          {\n            method: 'ping',\n            ...messageParams,\n          },\n          authURL.origin\n        );\n      } catch (error) {\n        console.warn('[Blockstack] Unable to send ping to authentication service');\n        clearInterval(interval);\n      }\n    } else {\n      console.warn('[Blockstack] Unable to send ping to authentication service - popup closed');\n    }\n    // If we haven't received a \"pong\" recently, then the popup was probably closed\n    // by the user. 750ms has been tested by most browsers. Most respond in less than\n    // 500ms, although Safari can often take around 600-650ms.\n    if (lastPong && new Date().getTime() - lastPong > pingInterval * 8) {\n      onCancel && onCancel();\n      clearInterval(interval);\n    }\n  }, pingInterval);\n\n  const receiveMessage = async (event: MessageEvent) => {\n    if (event.data.method === 'pong') {\n      lastPong = new Date().getTime();\n      return;\n    }\n    if (event.data.source === 'blockstack-app') {\n      const data = event.data as T;\n      await onFinish(data);\n      window.focus();\n      window.removeEventListener('message', receiveMessageCallback);\n      clearInterval(interval);\n    }\n  };\n\n  const receiveMessageCallback = (event: MessageEvent) => {\n    void receiveMessage(event);\n  };\n\n  window.addEventListener('message', receiveMessageCallback, false);\n};\n","import { AppConfig, UserSession } from 'blockstack';\nimport './types';\nimport { popupCenter, setupListener } from './popup';\nimport { version } from '../package.json';\n\nexport const defaultAuthURL = 'https://app.blockstack.org';\n\nif (typeof window !== 'undefined') {\n  (window as any).__CONNECT_VERSION__ = version;\n}\n\nexport interface FinishedData {\n  authResponse: string;\n  userSession: UserSession;\n}\n\nexport interface AuthOptions {\n  /** The URL you want the user to be redirected to after authentication. */\n  redirectTo?: string;\n  manifestPath?: string;\n  /** DEPRECATED: use `onFinish` */\n  finished?: (payload: FinishedData) => void;\n  /**\n   * This callback is fired after authentication is finished.\n   * The callback is called with a single object argument, with two keys:\n   * `userSession`: a UserSession object with `userData` included\n   * `authResponse`: the raw `authResponse` string that is returned from authentication\n   * */\n  onFinish?: (payload: FinishedData) => void;\n  /** This callback is fired if the user exits before finishing */\n  onCancel?: () => void;\n  authOrigin?: string;\n  sendToSignIn?: boolean;\n  userSession?: UserSession;\n  appDetails: {\n    name: string;\n    icon: string;\n  };\n}\n\nexport const isMobile = () => {\n  const ua = navigator.userAgent;\n  if (/android/i.test(ua)) {\n    return true;\n  }\n  if (/iPad|iPhone|iPod/.test(ua)) {\n    return true;\n  }\n  if (/safari/i.test(ua)) {\n    return true;\n  }\n  if (/windows phone/i.test(ua)) {\n    return true;\n  }\n  return false;\n};\n\n/**\n * mobile should not use a 'popup' type of window.\n */\nexport const shouldUsePopup = () => {\n  return !isMobile();\n};\n\nexport const getOrCreateUserSession = (userSession?: UserSession): UserSession => {\n  if (!userSession) {\n    const appConfig = new AppConfig(['store_write'], document.location.href);\n    userSession = new UserSession({ appConfig });\n  }\n  return userSession;\n};\n\nexport const authenticate = async ({\n  redirectTo = '/',\n  manifestPath,\n  finished,\n  onFinish,\n  onCancel,\n  authOrigin,\n  sendToSignIn = false,\n  userSession: _userSession,\n  appDetails,\n}: AuthOptions) => {\n  const userSession = getOrCreateUserSession(_userSession);\n  if (userSession.isUserSignedIn()) {\n    userSession.signUserOut();\n  }\n  const transitKey = userSession.generateAndStoreTransitKey();\n  const authRequest = userSession.makeAuthRequest(\n    transitKey,\n    `${document.location.origin}${redirectTo}`,\n    `${document.location.origin}${manifestPath}`,\n    userSession.appConfig.scopes,\n    undefined,\n    undefined,\n    {\n      sendToSignIn,\n      appDetails,\n      connectVersion: version,\n    }\n  );\n\n  const params = window.location.search\n    .substr(1)\n    .split('&')\n    .filter(param => param.startsWith('utm'))\n    .map(param => param.split('='));\n  const urlParams = new URLSearchParams();\n  params.forEach(([key, value]) => urlParams.set(key, value));\n  urlParams.set('authRequest', authRequest);\n\n  const path = sendToSignIn ? 'sign-in' : 'sign-up';\n\n  const extensionURL = await window.BlockstackProvider?.getURL();\n  const authURL = new URL(extensionURL || authOrigin || defaultAuthURL);\n\n  const url = `${authURL.origin}/index.html#/${path}?${urlParams.toString()}`;\n  if (shouldUsePopup()) {\n    const popup = popupCenter({\n      url,\n      // If the extension is installed, dont worry about popup blocking\n      // Otherwise, firefox will open the popup and a new tab.\n      skipPopupFallback: !!window.BlockstackProvider,\n    });\n\n    setupAuthListener({\n      popup,\n      authRequest,\n      onFinish: onFinish || finished,\n      authURL,\n      userSession,\n      onCancel,\n    });\n    return;\n  }\n\n  document.location.href = url;\n};\n\ninterface FinishedEventData {\n  authResponse: string;\n  authRequest: string;\n  source: string;\n}\n\ninterface ListenerParams {\n  popup: Window | null;\n  authRequest: string;\n  onFinish?: (payload: FinishedData) => void;\n  onCancel?: () => void;\n  authURL: URL;\n  userSession: UserSession;\n}\n\nconst setupAuthListener = ({\n  popup,\n  authRequest,\n  onFinish,\n  onCancel,\n  authURL,\n  userSession,\n}: ListenerParams) => {\n  setupListener<FinishedEventData>({\n    popup,\n    onCancel,\n    onFinish: async (data: FinishedEventData) => {\n      if (data.authRequest === authRequest) {\n        if (onFinish) {\n          const { authResponse } = data;\n          await userSession.handlePendingSignIn(authResponse);\n          onFinish({\n            authResponse,\n            userSession,\n          });\n        }\n      }\n    },\n    messageParams: {\n      authRequest,\n    },\n    authURL,\n  });\n};\n\nexport const getUserData = async (userSession?: UserSession) => {\n  userSession = getOrCreateUserSession(userSession);\n  if (userSession.isUserSignedIn()) {\n    return userSession.loadUserData();\n  }\n  if (userSession.isSignInPending()) {\n    return userSession.handlePendingSignIn();\n  }\n  return null;\n};\n","import { UserSession } from 'blockstack';\nimport { AuthOptions } from '../auth';\nimport {\n  PostConditionMode,\n  PostCondition,\n  StacksNetwork,\n  AnchorMode,\n  ClarityValue,\n} from '@blockstack/stacks-transactions';\nimport BN from 'bn.js';\n\nexport interface TxBase {\n  appDetails?: AuthOptions['appDetails'];\n  postConditionMode?: PostConditionMode;\n  postConditions?: PostCondition[];\n  network?: StacksNetwork;\n  anchorMode?: AnchorMode;\n  senderKey?: string;\n  nonce?: number;\n}\n\nexport interface FinishedTxData {\n  txId: string;\n  txRaw: string;\n}\n\nexport enum TransactionTypes {\n  ContractCall = 'contract_call',\n  ContractDeploy = 'smart_contract',\n  STXTransfer = 'token_transfer',\n}\n\n/**\n * Contract Call\n */\n\nexport enum ContractCallArgumentType {\n  BUFFER = 'buffer',\n  UINT = 'uint',\n  INT = 'int',\n  PRINCIPAL = 'principal',\n  BOOL = 'bool',\n}\n\nexport interface ContractCallBase extends TxBase {\n  contractAddress: string;\n  contractName: string;\n  functionName: string;\n  functionArgs: (string | ClarityValue)[];\n}\n\nexport interface ContractCallOptions extends ContractCallBase {\n  authOrigin?: string;\n  userSession?: UserSession;\n  finished?: (data: FinishedTxData) => void;\n}\n\nexport interface ContractCallArgument {\n  type: ContractCallArgumentType;\n  value: string;\n}\n\nexport interface ContractCallPayload extends ContractCallBase {\n  txType: TransactionTypes.ContractCall;\n  publicKey: string;\n  functionArgs: string[];\n}\n\n/**\n * Contract Deploy\n */\nexport interface ContractDeployBase extends TxBase {\n  contractName: string;\n  codeBody: string;\n}\n\nexport interface ContractDeployOptions extends ContractDeployBase {\n  authOrigin?: string;\n  userSession?: UserSession;\n  finished?: (data: FinishedTxData) => void;\n}\n\nexport interface ContractDeployPayload extends ContractDeployOptions {\n  publicKey: string;\n  txType: TransactionTypes.ContractDeploy;\n}\n\n/**\n * STX Transfer\n */\n\nexport interface STXTransferBase extends TxBase {\n  recipient: string;\n  amount: BN | string;\n  memo?: string;\n}\n\nexport interface STXTransferOptions extends STXTransferBase {\n  authOrigin?: string;\n  userSession?: UserSession;\n  finished?: (data: FinishedTxData) => void;\n}\n\nexport interface STXTransferPayload extends STXTransferOptions {\n  publicKey: string;\n  txType: TransactionTypes.STXTransfer;\n  amount: string;\n}\n\n/**\n * Transaction Popup\n */\n\nexport type TransactionOptions = ContractCallOptions | ContractDeployOptions | STXTransferOptions;\nexport type TransactionPayload = ContractCallPayload | ContractDeployPayload | STXTransferPayload;\n\nexport interface TransactionPopup {\n  token: string;\n  opts: TransactionOptions;\n}\n","import { UserSession, AppConfig } from 'blockstack';\nimport { SECP256K1Client, TokenSigner } from 'jsontokens';\nimport { defaultAuthURL } from '../auth';\nimport { popupCenter, setupListener } from '../popup';\nimport {\n  ContractCallOptions,\n  ContractCallPayload,\n  ContractDeployOptions,\n  ContractDeployPayload,\n  FinishedTxData,\n  TransactionPopup,\n  TransactionOptions,\n  STXTransferOptions,\n  STXTransferPayload,\n  TransactionPayload,\n  TransactionTypes,\n} from './types';\nimport { serializeCV } from '@blockstack/stacks-transactions';\n\nexport * from './types';\n\nconst getKeys = (_userSession?: UserSession) => {\n  let userSession = _userSession;\n\n  if (!userSession) {\n    const appConfig = new AppConfig(['store_write'], document.location.href);\n    userSession = new UserSession({ appConfig });\n  }\n\n  const privateKey = userSession.loadUserData().appPrivateKey;\n  const publicKey = SECP256K1Client.derivePublicKey(privateKey);\n\n  return { privateKey, publicKey };\n};\n\nconst signPayload = async (payload: TransactionPayload, privateKey: string) => {\n  const tokenSigner = new TokenSigner('ES256k', privateKey);\n  return tokenSigner.signAsync(payload as any);\n};\n\nconst openTransactionPopup = async ({ token, opts }: TransactionPopup) => {\n  const extensionURL = await window.BlockstackProvider?.getURL();\n  const authURL = new URL(extensionURL || opts.authOrigin || defaultAuthURL);\n  const urlParams = new URLSearchParams();\n  urlParams.set('request', token);\n\n  const popup = popupCenter({\n    url: `${authURL.origin}/index.html#/transaction?${urlParams.toString()}`,\n    h: 700,\n  });\n\n  setupListener<FinishedTxData>({\n    popup,\n    authURL,\n    onFinish: data => {\n      if (opts.finished) {\n        opts.finished(data);\n      }\n    },\n    messageParams: {},\n  });\n  return popup;\n};\n\nexport const makeContractCallToken = async (opts: ContractCallOptions) => {\n  const { functionArgs, appDetails, userSession, ...options } = opts;\n  const { privateKey, publicKey } = getKeys(userSession);\n\n  const args: string[] = functionArgs.map(arg => {\n    if (typeof arg === 'string') {\n      return arg;\n    }\n    return serializeCV(arg).toString('hex');\n  });\n\n  const payload: ContractCallPayload = {\n    ...options,\n    functionArgs: args,\n    txType: TransactionTypes.ContractCall,\n    publicKey,\n  };\n\n  if (appDetails) {\n    payload.appDetails = appDetails;\n  }\n\n  return signPayload(payload, privateKey);\n};\n\nexport const makeContractDeployToken = async (opts: ContractDeployOptions) => {\n  const { appDetails, userSession, ...options } = opts;\n  const { privateKey, publicKey } = getKeys(userSession);\n\n  const payload: ContractDeployPayload = {\n    ...options,\n    publicKey,\n    txType: TransactionTypes.ContractDeploy,\n  };\n\n  if (appDetails) {\n    payload.appDetails = appDetails;\n  }\n\n  return signPayload(payload, privateKey);\n};\n\nexport const makeSTXTransferToken = async (opts: STXTransferOptions) => {\n  const { amount, appDetails, userSession, ...options } = opts;\n  const { privateKey, publicKey } = getKeys(userSession);\n\n  const payload: STXTransferPayload = {\n    ...options,\n    amount: amount.toString(10),\n    publicKey,\n    txType: TransactionTypes.STXTransfer,\n  };\n\n  if (appDetails) {\n    payload.appDetails = appDetails;\n  }\n\n  return signPayload(payload, privateKey);\n};\n\nasync function generateTokenAndOpenPopup<T extends TransactionOptions>(\n  opts: T,\n  makeTokenFn: (opts: T) => Promise<string>\n) {\n  const token = await makeTokenFn(opts);\n  return openTransactionPopup({ token, opts });\n}\n\nexport const openContractCall = async (opts: ContractCallOptions) =>\n  generateTokenAndOpenPopup(opts, makeContractCallToken);\n\nexport const openContractDeploy = async (opts: ContractDeployOptions) =>\n  generateTokenAndOpenPopup(opts, makeContractDeployToken);\n\nexport const openSTXTransfer = async (opts: STXTransferOptions) =>\n  generateTokenAndOpenPopup(opts, makeSTXTransferToken);\n","import { authenticate, AuthOptions, FinishedData } from './auth';\nimport { defineCustomElements } from '@stacks/connect-ui';\n\nexport const showConnect = (authOptions: AuthOptions) => {\n  defineCustomElements();\n  const element = document.createElement('connect-modal');\n  element.authOptions = authOptions;\n  document.body.appendChild(element);\n  const finishedWrapper = (finishedData: FinishedData) => {\n    element.remove();\n    const callback = authOptions.onFinish || authOptions.finished;\n    if (callback) {\n      callback(finishedData);\n    }\n  };\n  element.addEventListener('onSignUp', () => {\n    authenticate({\n      ...authOptions,\n      sendToSignIn: false,\n      onFinish: finishedWrapper,\n    });\n  });\n  element.addEventListener('onSignIn', () => {\n    authenticate({\n      ...authOptions,\n      sendToSignIn: true,\n      onFinish: finishedWrapper,\n    });\n  });\n  const handleEsc = (ev: KeyboardEvent) => {\n    if (ev.key === 'Escape') {\n      document.removeEventListener('keydown', handleEsc);\n      element.remove();\n    }\n  };\n  element.addEventListener('onCloseModal', () => {\n    document.removeEventListener('keydown', handleEsc);\n    element.remove();\n  });\n  document.addEventListener('keydown', handleEsc);\n};\n\n/**\n * @deprecated Use the renamed `showConnect` method\n */\nexport const showBlockstackConnect = (authOptions: AuthOptions) => showConnect(authOptions);\n"],"names":["defaultWidth","defaultHeight","defaultTitle","popupCenter","url","title","w","h","skipPopupFallback","win","window","isSafari","safari","undefined","browserViewport","width","innerWidth","height","innerHeight","browserToolbarHeight","outerHeight","browserSidepanelWidth","outerWidth","removeUnusableSpaceX","coord","screen","availWidth","removeUnusableSpaceY","availHeight","browserPosition","x","screenX","y","screenY","left","top","options","scrollbars","optionsString","Object","keys","map","key","newWindow","open","join","focus","setupListener","popup","messageParams","onFinish","onCancel","authURL","lastPong","pingInterval","interval","setInterval","postMessage","method","origin","error","console","warn","clearInterval","Date","getTime","receiveMessage","event","data","source","removeEventListener","receiveMessageCallback","addEventListener","defaultAuthURL","__CONNECT_VERSION__","version","isMobile","ua","navigator","userAgent","test","shouldUsePopup","getOrCreateUserSession","userSession","appConfig","AppConfig","document","location","href","UserSession","authenticate","redirectTo","manifestPath","finished","authOrigin","sendToSignIn","_userSession","appDetails","isUserSignedIn","signUserOut","transitKey","generateAndStoreTransitKey","authRequest","makeAuthRequest","scopes","connectVersion","params","search","substr","split","filter","param","startsWith","urlParams","URLSearchParams","forEach","value","set","path","BlockstackProvider","getURL","extensionURL","URL","toString","setupAuthListener","authResponse","handlePendingSignIn","getUserData","loadUserData","isSignInPending","TransactionTypes","ContractCallArgumentType","generateTokenAndOpenPopup","opts","makeTokenFn","token","openTransactionPopup","getKeys","privateKey","appPrivateKey","publicKey","SECP256K1Client","derivePublicKey","signPayload","payload","tokenSigner","TokenSigner","signAsync","makeContractCallToken","functionArgs","args","arg","serializeCV","txType","ContractCall","makeContractDeployToken","ContractDeploy","makeSTXTransferToken","amount","STXTransfer","openContractCall","openContractDeploy","openSTXTransfer","showConnect","authOptions","defineCustomElements","element","createElement","body","appendChild","finishedWrapper","finishedData","remove","callback","handleEsc","ev","showBlockstackConnect"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAQA;AACA;AACA;AACA,IAAMA,YAAY,GAAG,GAArB;AACA,IAAMC,aAAa,GAAG,GAAtB;AACA,IAAMC,YAAY,GAAG,0BAArB;;IAGaC,WAAW,GAAG,SAAdA,WAAc;MACzBC,WAAAA;wBACAC;MAAAA,gCAAQH;oBACRI;MAAAA,wBAAIN;oBACJO;MAAAA,wBAAIN;MACJO,yBAAAA;AAEA,MAAMC,GAAG,GAAGC,MAAZ;;AAEA,MAAMC,QAAQ,GAAIF,GAAW,CAACG,MAAZ,KAAuBC,SAAzC;AAEA,MAAMC,eAAe,GAAG;AACtBC,IAAAA,KAAK,EAAEN,GAAG,CAACO,UADW;AAEtBC,IAAAA,MAAM,EAAER,GAAG,CAACS;AAFU,GAAxB;AAIA,MAAMC,oBAAoB,GAAGV,GAAG,CAACW,WAAJ,GAAkBX,GAAG,CAACS,WAAnD;AACA,MAAMG,qBAAqB,GAAGZ,GAAG,CAACa,UAAJ,GAAiBb,GAAG,CAACO,UAAnD;;AAGA,MAAMO,oBAAoB,GAAG,SAAvBA,oBAAuB,CAACC,KAAD;AAAA,WAC3BA,KAAK,IAAIf,GAAG,CAACgB,MAAJ,CAAWV,KAAX,GAAmBN,GAAG,CAACgB,MAAJ,CAAWC,UAAlC,CADsB;AAAA,GAA7B;;AAEA,MAAMC,oBAAoB,GAAG,SAAvBA,oBAAuB,CAACH,KAAD;AAAA,WAC3BA,KAAK,IAAIf,GAAG,CAACgB,MAAJ,CAAWR,MAAX,GAAoBR,GAAG,CAACgB,MAAJ,CAAWG,WAAnC,CADsB;AAAA,GAA7B;;AAGA,MAAMC,eAAe,GAAG;AACtBC,IAAAA,CAAC,EAAEP,oBAAoB,CAACd,GAAG,CAACsB,OAAL,CADD;AAEtBC,IAAAA,CAAC,EAAEL,oBAAoB,CAAClB,GAAG,CAACwB,OAAL;AAFD,GAAxB;AAKA,MAAMC,IAAI,GAAGL,eAAe,CAACC,CAAhB,GAAoBT,qBAApB,GAA4C,CAACP,eAAe,CAACC,KAAhB,GAAwBT,CAAzB,IAA8B,CAAvF;AACA,MAAM6B,GAAG,GACPN,eAAe,CAACG,CAAhB,GACAb,oBADA,GAEA,CAACL,eAAe,CAACG,MAAhB,GAAyBV,CAA1B,IAA+B,CAF/B,IAGCI,QAAQ,GAAG,EAAH,GAAQ,CAHjB,CADF;AAMA,MAAMyB,OAAO,GAAG;AACdC,IAAAA,UAAU,EAAE,IADE;AAEdtB,IAAAA,KAAK,EAAET,CAFO;AAGdW,IAAAA,MAAM,EAAEV,CAHM;AAId4B,IAAAA,GAAG,EAAHA,GAJc;AAKdD,IAAAA,IAAI,EAAJA;AALc,GAAhB;AAOA,MAAMI,aAAa,GAAGC,MAAM,CAACC,IAAP,CAAYJ,OAAZ,EAAqBK,GAArB,CAAyB,UAAAC,GAAG;AAChD,WAAUA,GAAV,SAAiBN,OAAO,CAACM,GAAD,CAAxB;AACD,GAFqB,CAAtB;AAGA,MAAMC,SAAS,GAAGjC,MAAM,CAACkC,IAAP,CAAYxC,GAAZ,EAAiBC,KAAjB,EAAwBiC,aAAa,CAACO,IAAd,CAAmB,GAAnB,CAAxB,CAAlB;;AAEA,MAAIF,SAAJ,EAAe;AACbA,IAAAA,SAAS,CAACG,KAAV;AACA,WAAOH,SAAP;AACD;;;AAGD,MAAInC,iBAAJ,EAAuB;AACrB,WAAOmC,SAAP;AACD;;AACD,SAAOjC,MAAM,CAACkC,IAAP,CAAYxC,GAAZ,CAAP;AACD;IAYY2C,aAAa,GAAG,SAAhBA,aAAgB;MAC3BC,cAAAA;MACAC,sBAAAA;MACAC,iBAAAA;MACAC,iBAAAA;MACAC,gBAAAA;AAEA,MAAIC,QAAQ,GAAkB,IAA9B;AAGA;;AACA,MAAMC,YAAY,GAAG,GAArB;AACA,MAAMC,QAAQ,GAAGC,WAAW,CAAC;AAC3B,QAAIR,KAAJ,EAAW;AACT,UAAI;AACFA,QAAAA,KAAK,CAACS,WAAN;AAEIC,UAAAA,MAAM,EAAE;AAFZ,WAGOT,aAHP,GAKEG,OAAO,CAACO,MALV;AAOD,OARD,CAQE,OAAOC,KAAP,EAAc;AACdC,QAAAA,OAAO,CAACC,IAAR,CAAa,4DAAb;AACAC,QAAAA,aAAa,CAACR,QAAD,CAAb;AACD;AACF,KAbD,MAaO;AACLM,MAAAA,OAAO,CAACC,IAAR,CAAa,2EAAb;AACD;AAED;AACA;;;AACA,QAAIT,QAAQ,IAAI,IAAIW,IAAJ,GAAWC,OAAX,KAAuBZ,QAAvB,GAAkCC,YAAY,GAAG,CAAjE,EAAoE;AAClEH,MAAAA,QAAQ,IAAIA,QAAQ,EAApB;AACAY,MAAAA,aAAa,CAACR,QAAD,CAAb;AACD;AACF,GAxB2B,EAwBzBD,YAxByB,CAA5B;;AA0BA,MAAMY,cAAc,YAAdA,cAAc,CAAUC,KAAV;AAAA;AAClB,UAAIA,KAAK,CAACC,IAAN,CAAWV,MAAX,KAAsB,MAA1B,EAAkC;AAChCL,QAAAA,QAAQ,GAAG,IAAIW,IAAJ,GAAWC,OAAX,EAAX;AACA;AACD;;;YACGE,KAAK,CAACC,IAAN,CAAWC,MAAX,KAAsB;AACxB,cAAMD,IAAI,GAAGD,KAAK,CAACC,IAAnB;iCACMlB,QAAQ,CAACkB,IAAD;AACd1D,YAAAA,MAAM,CAACoC,KAAP;AACApC,YAAAA,MAAM,CAAC4D,mBAAP,CAA2B,SAA3B,EAAsCC,sBAAtC;AACAR,YAAAA,aAAa,CAACR,QAAD,CAAb;;;;;;AAEH,KAZmB;AAAA;AAAA;AAAA,GAApB;;AAcA,MAAMgB,sBAAsB,GAAG,SAAzBA,sBAAyB,CAACJ,KAAD;AAC7B,SAAKD,cAAc,CAACC,KAAD,CAAnB;AACD,GAFD;;AAIAzD,EAAAA,MAAM,CAAC8D,gBAAP,CAAwB,SAAxB,EAAmCD,sBAAnC,EAA2D,KAA3D;AACD;;;;IC1IYE,cAAc,GAAG,4BAAvB;;AAEP,IAAI,OAAO/D,MAAP,KAAkB,WAAtB,EAAmC;AAChCA,EAAAA,MAAc,CAACgE,mBAAf,GAAqCC,OAArC;AACF;;AA+BD,IAAaC,QAAQ,GAAG,SAAXA,QAAW;AACtB,MAAMC,EAAE,GAAGC,SAAS,CAACC,SAArB;;AACA,MAAI,WAAWC,IAAX,CAAgBH,EAAhB,CAAJ,EAAyB;AACvB,WAAO,IAAP;AACD;;AACD,MAAI,mBAAmBG,IAAnB,CAAwBH,EAAxB,CAAJ,EAAiC;AAC/B,WAAO,IAAP;AACD;;AACD,MAAI,UAAUG,IAAV,CAAeH,EAAf,CAAJ,EAAwB;AACtB,WAAO,IAAP;AACD;;AACD,MAAI,iBAAiBG,IAAjB,CAAsBH,EAAtB,CAAJ,EAA+B;AAC7B,WAAO,IAAP;AACD;;AACD,SAAO,KAAP;AACD,CAfM;AAiBP;;;;AAGA,IAAaI,cAAc,GAAG,SAAjBA,cAAiB;AAC5B,SAAO,CAACL,QAAQ,EAAhB;AACD,CAFM;AAIP,IAAaM,sBAAsB,GAAG,SAAzBA,sBAAyB,CAACC,WAAD;AACpC,MAAI,CAACA,WAAL,EAAkB;AAChB,QAAMC,SAAS,GAAG,IAAIC,oBAAJ,CAAc,CAAC,aAAD,CAAd,EAA+BC,QAAQ,CAACC,QAAT,CAAkBC,IAAjD,CAAlB;AACAL,IAAAA,WAAW,GAAG,IAAIM,sBAAJ,CAAgB;AAAEL,MAAAA,SAAS,EAATA;AAAF,KAAhB,CAAd;AACD;;AACD,SAAOD,WAAP;AACD,CANM;AAQP,IAAaO,YAAY,YAAZA,YAAY;AAAA,6BACvBC,UADuB;AAAA,MACvBA,UADuB,gCACV,GADU;AAAA,MAEvBC,YAFuB,QAEvBA,YAFuB;AAAA,MAGvBC,QAHuB,QAGvBA,QAHuB;AAAA,MAIvB3C,QAJuB,QAIvBA,QAJuB;AAAA,MAKvBC,QALuB,QAKvBA,QALuB;AAAA,MAMvB2C,UANuB,QAMvBA,UANuB;AAAA,+BAOvBC,YAPuB;AAAA,MAOvBA,YAPuB,kCAOR,KAPQ;AAAA,MAQVC,YARU,QAQvBb,WARuB;AAAA,MASvBc,UATuB,QASvBA,UATuB;;AAAA;;;AAWvB,QAAMd,WAAW,GAAGD,sBAAsB,CAACc,YAAD,CAA1C;;AACA,QAAIb,WAAW,CAACe,cAAZ,EAAJ,EAAkC;AAChCf,MAAAA,WAAW,CAACgB,WAAZ;AACD;;AACD,QAAMC,UAAU,GAAGjB,WAAW,CAACkB,0BAAZ,EAAnB;AACA,QAAMC,WAAW,GAAGnB,WAAW,CAACoB,eAAZ,CAClBH,UADkB,OAEfd,QAAQ,CAACC,QAAT,CAAkB5B,MAFH,GAEYgC,UAFZ,OAGfL,QAAQ,CAACC,QAAT,CAAkB5B,MAHH,GAGYiC,YAHZ,EAIlBT,WAAW,CAACC,SAAZ,CAAsBoB,MAJJ,EAKlB3F,SALkB,EAMlBA,SANkB,EAOlB;AACEkF,MAAAA,YAAY,EAAZA,YADF;AAEEE,MAAAA,UAAU,EAAVA,UAFF;AAGEQ,MAAAA,cAAc,EAAE9B;AAHlB,KAPkB,CAApB;AAcA,QAAM+B,MAAM,GAAGhG,MAAM,CAAC6E,QAAP,CAAgBoB,MAAhB,CACZC,MADY,CACL,CADK,EAEZC,KAFY,CAEN,GAFM,EAGZC,MAHY,CAGL,UAAAC,KAAK;AAAA,aAAIA,KAAK,CAACC,UAAN,CAAiB,KAAjB,CAAJ;AAAA,KAHA,EAIZvE,GAJY,CAIR,UAAAsE,KAAK;AAAA,aAAIA,KAAK,CAACF,KAAN,CAAY,GAAZ,CAAJ;AAAA,KAJG,CAAf;AAKA,QAAMI,SAAS,GAAG,IAAIC,eAAJ,EAAlB;AACAR,IAAAA,MAAM,CAACS,OAAP,CAAe;AAAA,UAAEzE,GAAF;AAAA,UAAO0E,KAAP;AAAA,aAAkBH,SAAS,CAACI,GAAV,CAAc3E,GAAd,EAAmB0E,KAAnB,CAAlB;AAAA,KAAf;AACAH,IAAAA,SAAS,CAACI,GAAV,CAAc,aAAd,EAA6Bf,WAA7B;AAEA,QAAMgB,IAAI,GAAGvB,YAAY,GAAG,SAAH,GAAe,SAAxC;oDAE2BrF,MAAM,CAAC6G,4EAAP,sBAA2BC,MAA3B,mBAArBC;AACN,UAAMrE,OAAO,GAAG,IAAIsE,GAAJ,CAAQD,YAAY,IAAI3B,UAAhB,IAA8BrB,cAAtC,CAAhB;AAEA,UAAMrE,GAAG,GAAMgD,OAAO,CAACO,MAAd,qBAAoC2D,IAApC,SAA4CL,SAAS,CAACU,QAAV,EAArD;;AACA,UAAI1C,cAAc,EAAlB,EAAsB;AACpB,YAAMjC,KAAK,GAAG7C,WAAW,CAAC;AACxBC,UAAAA,GAAG,EAAHA,GADwB;AAExB;AACA;AACAI,UAAAA,iBAAiB,EAAE,CAAC,CAACE,MAAM,CAAC6G;AAJJ,SAAD,CAAzB;AAOAK,QAAAA,iBAAiB,CAAC;AAChB5E,UAAAA,KAAK,EAALA,KADgB;AAEhBsD,UAAAA,WAAW,EAAXA,WAFgB;AAGhBpD,UAAAA,QAAQ,EAAEA,QAAQ,IAAI2C,QAHN;AAIhBzC,UAAAA,OAAO,EAAPA,OAJgB;AAKhB+B,UAAAA,WAAW,EAAXA,WALgB;AAMhBhC,UAAAA,QAAQ,EAARA;AANgB,SAAD,CAAjB;AAQA;AACD;;AAEDmC,MAAAA,QAAQ,CAACC,QAAT,CAAkBC,IAAlB,GAAyBpF,GAAzB;;AACD,GAjEwB;AAAA;AAAA;AAAA,CAAlB;;AAkFP,IAAMwH,iBAAiB,GAAG,SAApBA,iBAAoB;MACxB5E,cAAAA;MACAsD,oBAAAA;MACApD,kBAAAA;MACAC,iBAAAA;MACAC,gBAAAA;MACA+B,oBAAAA;AAEApC,EAAAA,aAAa,CAAoB;AAC/BC,IAAAA,KAAK,EAALA,KAD+B;AAE/BG,IAAAA,QAAQ,EAARA,QAF+B;AAG/BD,IAAAA,QAAQ,YAASkB,IAAT;AAAA;;cACFA,IAAI,CAACkC,WAAL,KAAqBA;;kBACnBpD;oBACM2E,eAAiBzD,KAAjByD;uCACF1C,WAAW,CAAC2C,mBAAZ,CAAgCD,YAAhC;AACN3E,kBAAAA,SAAQ,CAAC;AACP2E,oBAAAA,YAAY,EAAZA,YADO;AAEP1C,oBAAAA,WAAW,EAAXA;AAFO,mBAAD,CAAR;;;;;;;;;;AAML,OAXO;AAAA;AAAA;AAAA,KAHuB;AAe/BlC,IAAAA,aAAa,EAAE;AACbqD,MAAAA,WAAW,EAAXA;AADa,KAfgB;AAkB/BlD,IAAAA,OAAO,EAAPA;AAlB+B,GAApB,CAAb;AAoBD,CA5BD;;AA8BA,IAAa2E,WAAW,YAAXA,WAAW,CAAU5C,WAAV;AAAA;AACtBA,IAAAA,WAAW,GAAGD,sBAAsB,CAACC,WAAD,CAApC;;AACA,QAAIA,WAAW,CAACe,cAAZ,EAAJ,EAAkC;AAChC,6BAAOf,WAAW,CAAC6C,YAAZ,EAAP;AACD;;AACD,QAAI7C,WAAW,CAAC8C,eAAZ,EAAJ,EAAmC;AACjC,6BAAO9C,WAAW,CAAC2C,mBAAZ,EAAP;AACD;;AACD,2BAAO,IAAP;AACD,GATuB;AAAA;AAAA;AAAA,CAAjB;;AC9JP,WAAYI;AACVA,EAAAA,gCAAA,kBAAA;AACAA,EAAAA,kCAAA,mBAAA;AACAA,EAAAA,+BAAA,mBAAA;AACD,CAJD,EAAYA,wBAAgB,KAAhBA,wBAAgB,KAAA,CAA5B;AAMA;AAIA,WAAYC;AACVA,EAAAA,kCAAA,WAAA;AACAA,EAAAA,gCAAA,SAAA;AACAA,EAAAA,+BAAA,QAAA;AACAA,EAAAA,qCAAA,cAAA;AACAA,EAAAA,gCAAA,SAAA;AACD,CAND,EAAYA,gCAAwB,KAAxBA,gCAAwB,KAAA,CAApC;;ICwFeC,qCAAAA,0BACbC,MACAC;;2BAEoBA,WAAW,CAACD,IAAD,kBAAzBE;AACN,aAAOC,oBAAoB,CAAC;AAAED,QAAAA,KAAK,EAALA,KAAF;AAASF,QAAAA,IAAI,EAAJA;AAAT,OAAD,CAA3B;;AACD;;;;;AA7GD,IAAMI,OAAO,GAAG,SAAVA,OAAU,CAACzC,YAAD;AACd,MAAIb,WAAW,GAAGa,YAAlB;;AAEA,MAAI,CAACb,WAAL,EAAkB;AAChB,QAAMC,SAAS,GAAG,IAAIC,oBAAJ,CAAc,CAAC,aAAD,CAAd,EAA+BC,QAAQ,CAACC,QAAT,CAAkBC,IAAjD,CAAlB;AACAL,IAAAA,WAAW,GAAG,IAAIM,sBAAJ,CAAgB;AAAEL,MAAAA,SAAS,EAATA;AAAF,KAAhB,CAAd;AACD;;AAED,MAAMsD,UAAU,GAAGvD,WAAW,CAAC6C,YAAZ,GAA2BW,aAA9C;AACA,MAAMC,SAAS,GAAGC,0BAAe,CAACC,eAAhB,CAAgCJ,UAAhC,CAAlB;AAEA,SAAO;AAAEA,IAAAA,UAAU,EAAVA,UAAF;AAAcE,IAAAA,SAAS,EAATA;AAAd,GAAP;AACD,CAZD;;AAcA,IAAMG,WAAW,YAAXA,WAAW,CAAUC,OAAV,EAAuCN,UAAvC;AAAA;AACf,QAAMO,WAAW,GAAG,IAAIC,sBAAJ,CAAgB,QAAhB,EAA0BR,UAA1B,CAApB;AACA,2BAAOO,WAAW,CAACE,SAAZ,CAAsBH,OAAtB,CAAP;AACD,GAHgB;AAAA;AAAA;AAAA,CAAjB;;AAKA,IAAMR,oBAAoB,YAApBA,oBAAoB;AAAA,MAAYD,KAAZ,QAAYA,KAAZ;AAAA,MAAmBF,IAAnB,QAAmBA,IAAnB;;AAAA;;;oDACG3H,MAAM,CAAC6G,4EAAP,sBAA2BC,MAA3B,mBAArBC;AACN,UAAMrE,OAAO,GAAG,IAAIsE,GAAJ,CAAQD,YAAY,IAAIY,IAAI,CAACvC,UAArB,IAAmCrB,cAA3C,CAAhB;AACA,UAAMwC,SAAS,GAAG,IAAIC,eAAJ,EAAlB;AACAD,MAAAA,SAAS,CAACI,GAAV,CAAc,SAAd,EAAyBkB,KAAzB;AAEA,UAAMvF,KAAK,GAAG7C,WAAW,CAAC;AACxBC,QAAAA,GAAG,EAAKgD,OAAO,CAACO,MAAb,iCAA+CsD,SAAS,CAACU,QAAV,EAD1B;AAExBpH,QAAAA,CAAC,EAAE;AAFqB,OAAD,CAAzB;AAKAwC,MAAAA,aAAa,CAAiB;AAC5BC,QAAAA,KAAK,EAALA,KAD4B;AAE5BI,QAAAA,OAAO,EAAPA,OAF4B;AAG5BF,QAAAA,QAAQ,EAAE,kBAAAkB,IAAI;AACZ,cAAIiE,IAAI,CAACxC,QAAT,EAAmB;AACjBwC,YAAAA,IAAI,CAACxC,QAAL,CAAczB,IAAd;AACD;AACF,SAP2B;AAQ5BnB,QAAAA,aAAa,EAAE;AARa,OAAjB,CAAb;AAUA,aAAOD,KAAP;;AACD,GAtByB;AAAA;AAAA;AAAA,CAA1B;;AAwBA,IAAaoG,qBAAqB,YAArBA,qBAAqB,CAAUf,IAAV;AAAA;QACxBgB,eAAsDhB,KAAtDgB;QAAcpD,aAAwCoC,KAAxCpC;QAAYd,cAA4BkD,KAA5BlD;QAAgB/C,wCAAYiG;;mBAC5BI,OAAO,CAACtD,WAAD;QAAjCuD,sBAAAA;QAAYE,qBAAAA;;AAEpB,QAAMU,IAAI,GAAaD,YAAY,CAAC5G,GAAb,CAAiB,UAAA8G,GAAG;AACzC,UAAI,OAAOA,GAAP,KAAe,QAAnB,EAA6B;AAC3B,eAAOA,GAAP;AACD;;AACD,aAAOC,8BAAW,CAACD,GAAD,CAAX,CAAiB5B,QAAjB,CAA0B,KAA1B,CAAP;AACD,KALsB,CAAvB;;AAOA,QAAMqB,OAAO,gBACR5G,OADQ;AAEXiH,MAAAA,YAAY,EAAEC,IAFH;AAGXG,MAAAA,MAAM,EAAEvB,wBAAgB,CAACwB,YAHd;AAIXd,MAAAA,SAAS,EAATA;AAJW,MAAb;;AAOA,QAAI3C,UAAJ,EAAgB;AACd+C,MAAAA,OAAO,CAAC/C,UAAR,GAAqBA,UAArB;AACD;;AAED,WAAO8C,WAAW,CAACC,OAAD,EAAUN,UAAV,CAAlB;AACD,GAvBiC;AAAA;AAAA;AAAA,CAA3B;AAyBP,IAAaiB,uBAAuB,YAAvBA,uBAAuB,CAAUtB,IAAV;AAAA;QAC1BpC,aAAwCoC,KAAxCpC;QAAYd,cAA4BkD,KAA5BlD;QAAgB/C,wCAAYiG;;oBACdI,OAAO,CAACtD,WAAD;QAAjCuD,uBAAAA;QAAYE,sBAAAA;;AAEpB,QAAMI,OAAO,gBACR5G,OADQ;AAEXwG,MAAAA,SAAS,EAATA,SAFW;AAGXa,MAAAA,MAAM,EAAEvB,wBAAgB,CAAC0B;AAHd,MAAb;;AAMA,QAAI3D,UAAJ,EAAgB;AACd+C,MAAAA,OAAO,CAAC/C,UAAR,GAAqBA,UAArB;AACD;;AAED,WAAO8C,WAAW,CAACC,OAAD,EAAUN,UAAV,CAAlB;AACD,GAfmC;AAAA;AAAA;AAAA,CAA7B;AAiBP,IAAamB,oBAAoB,YAApBA,oBAAoB,CAAUxB,IAAV;AAAA;QACvByB,SAAgDzB,KAAhDyB;QAAQ7D,aAAwCoC,KAAxCpC;QAAYd,cAA4BkD,KAA5BlD;QAAgB/C,wCAAYiG;;oBACtBI,OAAO,CAACtD,WAAD;QAAjCuD,uBAAAA;QAAYE,sBAAAA;;AAEpB,QAAMI,OAAO,gBACR5G,OADQ;AAEX0H,MAAAA,MAAM,EAAEA,MAAM,CAACnC,QAAP,CAAgB,EAAhB,CAFG;AAGXiB,MAAAA,SAAS,EAATA,SAHW;AAIXa,MAAAA,MAAM,EAAEvB,wBAAgB,CAAC6B;AAJd,MAAb;;AAOA,QAAI9D,UAAJ,EAAgB;AACd+C,MAAAA,OAAO,CAAC/C,UAAR,GAAqBA,UAArB;AACD;;AAED,WAAO8C,WAAW,CAACC,OAAD,EAAUN,UAAV,CAAlB;AACD,GAhBgC;AAAA;AAAA;AAAA,CAA1B;AA0BP,IAAasB,gBAAgB,YAAhBA,gBAAgB,CAAU3B,IAAV;AAAA,SAC3BD,yBAAyB,CAACC,IAAD,EAAOe,qBAAP,CADE;AAAA,CAAtB;AAGP,IAAaa,kBAAkB,YAAlBA,kBAAkB,CAAU5B,IAAV;AAAA,SAC7BD,yBAAyB,CAACC,IAAD,EAAOsB,uBAAP,CADI;AAAA,CAAxB;AAGP,IAAaO,eAAe,YAAfA,eAAe,CAAU7B,IAAV;AAAA,SAC1BD,yBAAyB,CAACC,IAAD,EAAOwB,oBAAP,CADC;AAAA,CAArB;;ICvIMM,WAAW,GAAG,SAAdA,WAAc,CAACC,WAAD;AACzBC,EAAAA,8BAAoB;AACpB,MAAMC,OAAO,GAAGhF,QAAQ,CAACiF,aAAT,CAAuB,eAAvB,CAAhB;AACAD,EAAAA,OAAO,CAACF,WAAR,GAAsBA,WAAtB;AACA9E,EAAAA,QAAQ,CAACkF,IAAT,CAAcC,WAAd,CAA0BH,OAA1B;;AACA,MAAMI,eAAe,GAAG,SAAlBA,eAAkB,CAACC,YAAD;AACtBL,IAAAA,OAAO,CAACM,MAAR;AACA,QAAMC,QAAQ,GAAGT,WAAW,CAAClH,QAAZ,IAAwBkH,WAAW,CAACvE,QAArD;;AACA,QAAIgF,QAAJ,EAAc;AACZA,MAAAA,QAAQ,CAACF,YAAD,CAAR;AACD;AACF,GAND;;AAOAL,EAAAA,OAAO,CAAC9F,gBAAR,CAAyB,UAAzB,EAAqC;AACnCkB,IAAAA,YAAY,cACP0E,WADO;AAEVrE,MAAAA,YAAY,EAAE,KAFJ;AAGV7C,MAAAA,QAAQ,EAAEwH;AAHA,OAAZ;AAKD,GAND;AAOAJ,EAAAA,OAAO,CAAC9F,gBAAR,CAAyB,UAAzB,EAAqC;AACnCkB,IAAAA,YAAY,cACP0E,WADO;AAEVrE,MAAAA,YAAY,EAAE,IAFJ;AAGV7C,MAAAA,QAAQ,EAAEwH;AAHA,OAAZ;AAKD,GAND;;AAOA,MAAMI,SAAS,GAAG,SAAZA,SAAY,CAACC,EAAD;AAChB,QAAIA,EAAE,CAACrI,GAAH,KAAW,QAAf,EAAyB;AACvB4C,MAAAA,QAAQ,CAAChB,mBAAT,CAA6B,SAA7B,EAAwCwG,SAAxC;AACAR,MAAAA,OAAO,CAACM,MAAR;AACD;AACF,GALD;;AAMAN,EAAAA,OAAO,CAAC9F,gBAAR,CAAyB,cAAzB,EAAyC;AACvCc,IAAAA,QAAQ,CAAChB,mBAAT,CAA6B,SAA7B,EAAwCwG,SAAxC;AACAR,IAAAA,OAAO,CAACM,MAAR;AACD,GAHD;AAIAtF,EAAAA,QAAQ,CAACd,gBAAT,CAA0B,SAA1B,EAAqCsG,SAArC;AACD,CArCM;AAuCP;;;;AAGA,IAAaE,qBAAqB,GAAG,SAAxBA,qBAAwB,CAACZ,WAAD;AAAA,SAA8BD,WAAW,CAACC,WAAD,CAAzC;AAAA,CAA9B;;;;;;;;;;;;;;;;;;;;;;;;;;;"}